#LR5
##Chapter 12 - Testing
####Test Mode

Rails applications can be run in 3 modes, or "environments": **Development**, **Test**, and **Production**. To switch from the default mode, _development_, to _test_ mode, issue the following command at the terminal command prompt:

		rails server -e test

####Setting Up a Test Database with Fixtures

**Fixtures** allow developers to define stable data for use in the test database. Fixtures are written in YAML and the Rails scaffolding generator provides us with the basic files in the _test/fixtures_ directory. 

Open _test/fixtures/students.yml_ in the text editor and change the existing generic fixtures to read as follows:

        magnum:
          given_name: Thomas
          middle_name: Sullivan
          family_name: Magnum
          date_of_birth: 1945-01-29
          grade_point_average: 2.92
          start_date: 1988-09-12

        rick:
          given_name: Orville
          middle_name: Wilbur
          family_name: Richard
          date_of_birth: 1943-07-23
          grade_point_average: 3.94
          start_date: 1988-09-12

        tc:
          given_name: Theodore
          middle_name:
          family_name: Calvin
          date_of_birth: 1939-12-18
          grade_point_average: 3.76
          start_date: 1988-09-12

These values, although obviously made-up, more closely represent those expected from our application. Likewise, update the _test/fixtures/awards.yml_ file with the following fixture data:

        pi:
          name: Private Investigator
          year: 1988
          student: magnum

        pilot:
          name: Helicopter Pilot - Island Hoppers
          year: 1990
          student: tc

        owner:
          name: King Kamehameha Club
          year: 1989
          student: rick

Finally, edit the contents of _test/fixtures/courses.yml_ like so:

        surveillance:
          name: Escape and Evasion
          students: magnum, rick

        security:
          name: "Personal and private property security"
          students: magnum, rick

        aviation:
          name: "Aviation Safety"
          students: tc

####Model Testing

Firstly, note the constraints defined in  in *students06/app/models/award.rb*:

        class Award < ApplicationRecord
          # every award is linked to a student, through student_id
          belongs_to :student

          validates_presence_of :name, :year

          # particular award can only be given once in every year
          validates_uniqueness_of :name, :scope => :year,
            :message => "already been given for that year"

          # we started the award scheme in 1980
          validates_inclusion_of :year, :in => (1980 .. Date.today.year)
        end

The model test files generated by Rails scaffolding are not particularly useful. Open *students06/test/models/award_test.rb* and add some code to ensure the `year` constraint behaves as expected:

        require 'test_helper'

        class AwardTest < ActiveSupport::TestCase
          def test_validity_of_year

            # test for rejection of missing year
            award = Award.new({:name => "Test award"})
            assert !award.valid?

            # test under lower boundary
            award.year = 1979
            assert !award.valid?

            # lower boundary
            award.year = 1980
            assert award.valid?

            # top boundary
            award.year = Date.today.year
            assert award.valid?

            # top boundary case, award isn't valid for next year
            award.year = Date.today.year + 1
            assert !award.valid?
          end
        end

Now open *students06/test/models/course_test.rb* and app some basic functionality to get a sense of how model tests are put together:

        require 'test_helper'

            class CourseTest < ActiveSupport::TestCase
            def test_validity
              course = Course.new
              assert !course.valid?
              course.name = "New course"
              assert course.valid?
          end
        end

In *students06/test/models/student_test.rb*, let us examine some more complicated test procedures. Here we begin by specifying the **fixtures** that need to be loaded for these tests. This will allow us to reference the "sort of" real data in *students06/test/fixtures/students.yml* and *students06/test/fixtures/courses.yml*.

        require 'test_helper'

        class StudentTest < ActiveSupport::TestCase

          fixtures :students, :courses

          def test_validity
            jonathan = Student.new({:given_name => "Jonathan",
                :family_name => "Higgins"})
            assert !jonathan.valid?, "Should require date of birth, start date"
            jonathan.date_of_birth = "1989-02-03"
            jonathan.start_date = Date.today
            assert jonathan.valid?, "Failed even with all required info"
          end


          def test_name
            jonathan = Student.new({:given_name => "Jonathan",
                :family_name => "Higgins"})
            assert_equal jonathan.name, "Jonathan Higgins", "name method screwed up"
          end

          def test_enrolled_in
            tc = students(:tc)
            assert tc.enrolled_in?(courses(:aviation)), "TC not enrolled in surveillance?"
            assert !tc.enrolled_in?(courses(:security)), "TC should stay out of security"
          end

          def test_unenrolled_courses
            magnum = students(:magnum)
            rick = students(:rick)
            assert_equal [courses(:aviation)], magnum.unenrolled_courses
            assert_equal [courses(:aviation)], rick.unenrolled_courses
            jonathan = Student.new({:given_name => "Jonathan", :family_name => "Higgins"})
            assert_equal Course.all, jonathan.unenrolled_courses
          end
        end

To run model tests, enter `rake test:models` at the command prompt. (For unit testing we would use `rake test:units`.)

####Controller Testing

Scaffolding has provided some test files in the *students06/test/controllers/* directory. For example, *courses_controller_test.rb* is capable of testing the functionality of RESTful methods. However, much greater functionality can be achieved by adding more detail...

        require 'test_helper'

        class CoursesControllerTest < ActionController::TestCase
          def test_should_get_index
            get :index
            assert_response :success
            assert_not_nil assigns(:courses)
          end

          def test_should_get_new
            get :new
            assert_response :success
          end

          def test_should_create_course
            assert_difference('Course.count') do
              post :create, :course => { :name => "Cattle Rustling" }
            end

            assert_redirected_to course_path(assigns(:course))
          end

          def test_should_show_course
            get :show, :id => courses(:surveillance).id
            assert_response :success
          end

          def test_should_get_edit
            get :edit, :id => courses(:surveillance).id
            assert_response :success
          end

          def test_should_update_course
            put :update, :id => courses(:surveillance).id, :course => { :name => "Singing" }
            assert_redirected_to course_path(assigns(:course))
          end

          def test_should_destroy_course
            assert_difference('Course.count', -1) do
              delete :destroy, :id => courses(:surveillance).id
            end

            assert_redirected_to courses_path
          end
        end

Here, we've made the controller test a bit more "personal", by adding names that are actually supported by the model, like those found in the *courses.yml* fixture.
A little more detail on what's going on in these test metho ds... 

#####Calling Controllers

In the above `test_should_create_course` method, the RESTful verb **post** is used to ensure that a course can be created with "Cattle Rustling" as its **name** parameter. All types of HTTP requests should be tested.

#####Testing Responses

<sup>Refer to the Chapter 12 text for explanations of the **assertion methods** shown above.</sup>

#####Dealing with Nested Resources

The **Awards** model is nested under **Students**. Therefore a bit more information is needed in *students06/test/controllers/awards_controller_test.rb*...

        require 'test_helper'

        class AwardsControllerTest < ActionController::TestCase
          def test_should_get_index
            get :index, student_id: students(:magnum).id
            assert_response :success
            assert_not_nil assigns(:awards)
          end

          def test_should_get_new
            get :new, student_id: students(:magnum).id
            assert_response :success
          end

          def test_should_create_award
            assert_difference('Award.count') do
              post :create, award: { year: 2008, name: 'Test award' },
        student_id: students(:magnum).id
            end

            assert_redirected_to assert_redirected_to student_awards_url(students(:magnum))
          end

          def test_should_show_award
            get :show, id: awards(:skydiving).id, student_id: students(:magnum).id
            assert_response :success
          end

          def test_should_get_edit
            get :edit, id: awards(:skydiving).id, student_id: students(:magnum).id
            assert_response :success
          end

          def test_should_update_award
            put :update, id: awards(:skydiving).id, award: { }, student_id:
        students(:magnum).id
            assert_redirected_to student_awards_url(students(:magnum))
          end

          def test_should_destroy_award
            assert_difference('Award.count', -1) do
              delete :destroy,  id: awards(:skydiving).id,student_id:
        students(:magnum).id
            end

            assert_redirected_to student_awards_path(students(:magnum))
          end
        end

Running these tests is similar to running the model tests. Issue the command `rake test:controllers` at the command prompt.

####Integration Testing

In order to comprehensively test routing, controllers, models, views, and database interactivity, Rails provides support for *integration testing*. Open *test/integration/student_test.rb* and study the following code, taking note of how the integration test literally procedes through entire application processes - from retrieving the form with an HTTP *get* method, to ensuring that the browser is redirected once the new student is created and displays the appropriate information in the view.

        require 'test_helper'

				# Integration tests covering the manipulation of student objects

				class StudentsTest < ActionDispatch::IntegrationTest

				  def test_adding_a_student
				    # get the new student form
				    get '/students/new' # could be new_students_path

				    # check there are boxes to put the name in
				    # trivial in our case, but illustrates how to check output HTML
				    assert_select "input[type=text][name='student[given_name]']"
				    assert_select "input[type=text][name='student[family_name]']"

				    assert_difference('Student.count') do
				      post '/students', student: {
				        given_name: "Fred",
				        family_name: "Smith",
				        date_of_birth: "1999-09-01",
				        grade_point_average: 2.0,
				        start_date: "2008-09-01"
				      }
				    end

				    assert_redirected_to student_path(Student.last)
				    follow_redirect!

				    # for completeness, check it's showing some of our data
				    assert_select "p", /Fred/
				    assert_select "p", /2008\-09\-01/
				  end

				end

Now, to run this test, enter `rake test:integration` at the command prompt.

